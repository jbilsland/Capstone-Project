<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.survey.site.api.mappers.SurveyMapper">
    <resultMap id="question" type="com.survey.site.api.dto.Question">
        <id property="id" column="question_id"/>
        <result property="name" column="question"/>
        <result property="templateName" column="template_name"/>
    </resultMap>

    <resultMap id="response" type="com.survey.site.api.dto.Response">
        <id property="id" column="response_id"/>
        <result property="questionId" column="question_id"/>
        <result property="response" column="response"/>
    </resultMap>

    <resultMap id="survey" type="com.survey.site.api.dto.Survey">
        <id property="id" column="survey_all_id"/>
        <result property="name" column="survey_name"/>
        <collection property="questions" resultMap="question" javaType="java.util.List"/>
        <collection property="responses" resultMap="response" javaType="java.util.List"/>
    </resultMap>

    <select id="getQuestionsByTemplate" resultMap="question">
        SELECT *
        FROM questions
        WHERE template_name = #{template}
    </select>

    <insert id="createSurvey">
        INSERT INTO surveyAll(survey_name, template_name)
        VALUES (#{name}, #{templateName})

        <selectKey resultType="Long" order="AFTER" keyProperty="id">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <select id="getSurveyNames" resultType="String">
        SELECT survey_name
        FROM surveyAll
    </select>

    <select id="getAllSurveys" resultMap="survey">
        SELECT
            s.survey_all_id,
            survey_name,
            response,
            question
        FROM surveyAll s
        JOIN responses r ON r.survey_all_id = s.survey_all_id
        JOIN questions q ON q.question_id = r.question_id;
    </select>

</mapper>